#program-test #property-based-testing #text-case-reduction 


>[!def] internal reduction
> **internal reduction** is _shortlex optimisation_ over the _choice sequences_ leading to interesting generated test cases.

>[!tldr]
>Internal reduction works by performing test-case reduction not on the generated test case, but on the choice sequence that lead to it, with the hope that the test case corresponding to the reduced choice sequence is an improvement on the original.

# Backgrounds 

>[!def] PRNG
> Any _random generator_ or _random variable_ can be though as a deterministic function from a _finite bit array_ to its value domain. 
>
> **Pseudo-random number generator (PRNG)** provides an interface that the _generator requests bits from_, with each bit corresponding to a nondeterministic binary decision (a “coin ﬂip”).

>[!def] choice sequence
> The _bit sequence_ (possibly infinite) generated by a _PRNG_ is called a **choice sequence** 

> [!rmk] random generator
> **Random generators** can be thought as _parsers_ of _choice sequences_, with the _PRNG_ as a stream interface for reading the next bits from some underlying _choice sequence_.

>[!rmk] finite sequence parser
> A PRNG can produce inﬁnitely many choices, but _we can turn a generator into a parser of ﬁnite choice sequences_ by raising an exception when the generator reads too many bits, treating a too-short choice sequence as a parse error in the language deﬁned by considering the generator as a parser.

>[!def] shortlex order
> **Shortlex order** is a _total order_ over _finite sequences_ drawn from a set equipped with a total order. 
> 
> In the **shortlex ordering**, sequences are _primarily sorted by cardinality (length)_ with the shortest sequences first, and sequences of the same length are sorted into _lexicographical order_.
>
> For example, the shortlex order of the set of strings on the English alphabet (in its usual order) is 
> $$\{ \epsilon, a, b, c, \dots, z, aa, ab, ac, \dots, zz, aaa, aab, aac, \dots, zzz, \dots \}.$$

> [!remark] shrinking as reduction order
> A _test-case reducer_ or _shrinker_ is equivalently a _total order_ over _test-cases_ together with an algorithm to reach _minimal interesting test case_, where _interesting_ usually means a counter-example

## length of choice sequence is highly correlated to size of generated test case

> The length of the choice sequence is a strong but not perfect predictor of the test case size.

Intuitively, test cases of larger size needs to generate more fields which consumes more choice bits.

However, _rejection sampling_ may abandon a large chunk of sequence if the generated value cannot pass some filter. Thus the correlation can be low when
1. generate value within some bound by rejection
2. test properties that includes a _implies_ structure, such as "if p then q" and "p => q".

# Hypothesis's internal shrinker

[Source code for Shrinker in Hypothesis](https://github.com/HypothesisWorks/hypothesis/blob/master/hypothesis-python/src/hypothesis/internal/conjecture/shrinker.py)

>[!rmk] syntactically correct 
> if we treat a generator as _parsers_ of finite choice sequences, the choice sequence under shrinking must be _syntactically correct_ w.r.t. the parser. Obviously the shrinking result must also be _syntactically correct_. 

we say a choice sequence is _atomic_ if removing any single bit triggers a parsing error.

```haskell
data StructuredChoiceSeq 
  = Atomic [Byte]
  | Composed [ChoiceSeq]

type Gen a = StdGen -> (a, StructuredChoiceSeq, StdGen)
```


>[!warning] pitfall
> There is one pitfall when writing generator for internal shrinking. Each bit or word of the choice sequence or sample tree corresponding to 
> - some field of some type
> - choice of data constructor
> - control flow like `if then else`
>
> It is favourable if we can assure these correspondences **do not change** during shrinking. 
>
> It is not recommended to introduce random on `if`'s _condition expression and at least one of its branches_, as when the condition shrinks, some bits can be used to generate difference fields. A solution is generate both branches and use a if to choose. 
